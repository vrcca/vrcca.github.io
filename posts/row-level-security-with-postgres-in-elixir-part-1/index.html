<!DOCTYPE html>
<html lang="en-US" class="scroll-smooth dark">
  <head> 

<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Row-level Security with Postgres in Elixir</title>
<meta name="description" content="This is a dump from my recent experience implementing Row-level security in Elixir and Postgres for dynamically defined tenants.">
<link rel="canonical" href="https://blog.vitor.info/posts/row-level-security-with-postgres-in-elixir-part-1/">
<link rel="robots" href="/robots.txt" />

<link rel="icon" type="image/x-icon" href="/icons/favicon.ico">
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script type="text/x-mathjax-config">MathJax.Hub.Config({ tex2jax: { inlineMath: [['$','$'], ['\\(','\\)']] } });</script>

<link rel="stylesheet" href="https://blog.vitor.info/css/app.min.ae63891363b874de0ed4feb69beb0991bbf9fd9132d8abe3321ba8fefc4c13df.css" integrity="sha256-rmOJE2O4dN4O1P62m+sJkbv5/ZEy2KvjMhuo/vxME98=" /></head>

  <body class="max-w-screen-md mx-auto">
    <div class="header">
      <header class="flex flex-col sm:flex-row items-center gap-5 sm:gap-10 pt-16 py-12">
   


<div class="flex-none w-20 h-20 rounded-full overflow-hidden">
  <a href="https://blog.vitor.info/">
    <img
      srcset="/img/profile-picture_hub20fe4bee6a3f97e18720e55e817067e_138278_80x80_fill_q90_box_smart1.jpg 80w"
      src="/img/profile-picture.jpg"
      width="774"
      height="800"
      alt="Vitor Cavalcanti"
    />
  </a>
</div>

  
  <div class="flex flex-col gap-5">
    <a href="https://blog.vitor.info/">
  <h1 id="site-title">Vitor Cavalcanti</h1>
</a>
 
    <nav>
  <ul>
     
    
    <li>
      <a href="/" class="">
        Home
      </a>
    </li>
    
    <li>
      <a href="/posts" class="">
        Posts
      </a>
    </li>
    
    <li>
      <a href="/categories" class="">
        Categories
      </a>
    </li>
    
    <li>
      <a href="/tags" class="">
        Tags
      </a>
    </li>
    
  </ul>
</nav>

  </div>
</header>

      <button class="toggle-theme" aria-label="Toggle Theme" title="Toggle Theme" onclick="toggleTheme()">
  <span class="theme-icon light"> <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
    <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" />
</svg> </span>
  <span class="theme-icon dark"> <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
    <path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z" />
</svg> </span>
</button>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const theme = localStorage.getItem('theme');

    if (!theme || theme === 'light') {
      setTheme('light');
    } else {
      setTheme(theme);
    }
  });

  function setTheme(theme) {
    const html = document.querySelector('html');
    localStorage.setItem('theme', theme);

    if (theme === 'light') {
      if (html.classList.contains('dark')) {
        document.querySelector('html').classList.remove('dark');
      }

      document.querySelector('.theme-icon.light').style.display = 'none';
      document.querySelector('.theme-icon.dark').style.display = 'block';
    } else {
      if (!html.classList.contains('dark')) {
        document.querySelector('html').classList.add('dark');
      }

      document.querySelector('.theme-icon.dark').style.display = 'none';
      document.querySelector('.theme-icon.light').style.display = 'block';
    }
  }

  function toggleTheme() {
    const theme = localStorage.getItem('theme');

    if (theme === 'light') {
      setTheme('dark');
    } else {
      setTheme('light');
    }
  }
</script>
    </div>
  
    <main id="content">

<article class="flex flex-col gap-10">
  <header class="flex flex-col gap-2">
    <h2 class="title-large">Row-level Security with Postgres in Elixir</h2>

    <div class="meta">
      
      <time datetime="2024-02-10 12:39:02 &#43;0100 &#43;0100" title='Sat, Feb 10, 2024, 12:39 PM &#43;0100'>
        10/02/2024 - Estimated reading time: 9 minutes
      </time>

       
       — 
        
          <a class="categories" href="/categories/tutorials/" alt="Tutorials">
            Tutorials
          </a>
        
          <a class="categories" href="/categories/elixir/" alt="Elixir">
            Elixir
          </a>
         
      
    </div>
  </header>

  

  <section><p>This is a dump from my recent experience implementing Row-level security in Elixir and Postgres for dynamically defined tenants.</p>
<h1 id="whats-row-level-security">What’s row-level security?</h1>
<p>We need Row-level security (or just RLS) when we want certain users of the app to only see certain rows of the database. A good example is a user that, once logged in a banking app, can only see their transactions instead of the other users.</p>
<h1 id="how">How?</h1>
<h2 id="the-ecto-way">The Ecto way</h2>
<p>There are a few ways of doing that like checking for a user_id (a.k.a tenant identifier, or tenant id) in the query or before any changes to a row, you check if that row belongs to that user. However that requires developers to always remember that any database access has this check or query filter, which is prone to human error.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-0-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-1">1</a></span><span>Repo.<span style="color:#007020;font-weight:bold">all</span>(<span style="color:#007020;font-weight:bold">from</span>(<span style="color:#007020;font-weight:bold">transaction</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">in</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">Transaction</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-0-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-2">2</a></span><span><span style="color:#bbb">			  </span><span style="color:#007020;font-weight:bold">where</span>:<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">transaction</span>.user_id<span style="color:#bbb"> </span><span style="color:#666">==</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">current_user</span>.id))<span style="color:#bbb">
</span></span></span></code></pre></div><p>If we forget the <code>where</code> above, we&rsquo;ll let any user see transactions from all other users! Now imagine doing this for every DB operation. For updating and deleting data you also need to filter it:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-elixir" data-lang="elixir"><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-1-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-1">1</a></span><span><span style="color:#0e84b5;font-weight:bold">Repo</span><span style="color:#666">.</span>update_all(from(transaction <span style="color:#007020;font-weight:bold">in</span> <span style="color:#0e84b5;font-weight:bold">Transaction</span>,
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-1-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-2">2</a></span><span>			  <span style="color:#517918">where</span>: transaction<span style="color:#666">.</span>user_id <span style="color:#666">==</span> current_user<span style="color:#666">.</span>id),
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-1-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-3">3</a></span><span>			  <span style="color:#517918">set</span>: [<span style="color:#517918">status</span>: <span style="color:#517918">:active</span>])
</span></span></code></pre></div><p>Or if you need to update one transaction:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-elixir" data-lang="elixir"><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-2-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-1">1</a></span><span>transaction <span style="color:#666">=</span> <span style="color:#0e84b5;font-weight:bold">Repo</span><span style="color:#666">.</span>get(<span style="color:#0e84b5;font-weight:bold">Transaction</span>, <span style="color:#40a070">123</span>) <span style="color:#60a0b0;font-style:italic"># or get_by(id: 123, user_id: ...)</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-2-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-2">2</a></span><span><span style="color:#007020;font-weight:bold">if</span> transaction<span style="color:#666">.</span>user_id <span style="color:#666">==</span> current_user<span style="color:#666">.</span>id <span style="color:#007020;font-weight:bold">do</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-2-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-3">3</a></span><span>   <span style="color:#60a0b0;font-style:italic"># update!</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-2-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-4">4</a></span><span><span style="color:#007020;font-weight:bold">else</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-2-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-5">5</a></span><span>  {<span style="color:#517918">:error</span>, <span style="color:#517918">:forbidden</span>}
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-2-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-6">6</a></span><span><span style="color:#007020;font-weight:bold">end</span>
</span></span></code></pre></div><p>This pattern repeats all over the place.</p>
<h2 id="the-postgres-way">The Postgres way</h2>
<p>Instead of manually typing filters for every operation, we can create policies and let Postgres do that work for us. So we can run only this:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-elixir" data-lang="elixir"><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-3-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-3-1">1</a></span><span><span style="color:#0e84b5;font-weight:bold">Repo</span><span style="color:#666">.</span>all(from(transaction <span style="color:#007020;font-weight:bold">in</span> <span style="color:#0e84b5;font-weight:bold">Transaction</span>))
</span></span></code></pre></div><p>Postgres took care of the rest!</p>
<h1 id="the-example">The example</h1>
<p>I&rsquo;d like to explain how to do the Postgres way by changing an existing app, so let’s add row-level security to Chris McCord’s <a href="https://github.com/chrismccord/todo_trek/">TodoTrek</a>. It currently relies on the tenant_id checks, but we’ll make it work with Postgres RLS instead!</p>
<h3 id="running-the-app">Running the app</h3>
<p><strong>Let&rsquo;s start by cloning the repo</strong>:
<code>git clone git@github.com:chrismccord/todo_trek.git</code></p>
<p>If any of the examples below fails, the latest commit for me was <code>4d7357428993ce46625e1d39cb0fda9c0a832fc6</code>.</p>
<p>The versions I used:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-4-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-4-1">1</a></span><span>$ mise current
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-4-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-4-2">2</a></span><span>erlang 26.2.1
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-4-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-4-3">3</a></span><span>elixir 1.16.0-otp-26
</span></span></code></pre></div><p><strong>Start Postgres</strong>
I am going to use Docker in this example, but you can use it however you want, as long as you set a superuser credential in the <code>config/dev.exs</code> because I will be assuming so:
<code>docker run --name todotrek -d -p 5432:5432 -e POSTGRES_PASSWORD=postgres postgres</code></p>
<blockquote>
<p>TodoTrek locally runs with a Postgres user that has superuser powers, <code>postgres</code>, I’ll keep it like that because we are retrofitting an app, which in my experience was the most common scenario I found since startups wouldn’t bother about RLS before getting enough traction and real moneys.</p>
</blockquote>
<p><strong>Pull dependencies &amp; build</strong>
Run:
<code>mix setup</code></p>
<p>If we try to run <code>mix test</code>, we&rsquo;ll see about 17 errors. I&rsquo;ll just accept fate and rely on manual testing.</p>
<p><strong>Start the app</strong>
Run <code>mix phx.server</code>, open the browser at http://localhost:4000 and get used to it! To log in, just type &ldquo;password password&rdquo; in the password field.</p>
<p>Now create a new user so that we can test it manually. I created a new one with the same password above, but the email <a href="mailto:anotheruser@example.com">anotheruser@example.com</a>. Also create some Todos for it.</p>





<figure class='mb-5'>
  <img src="/posts/row-level-security-with-postgres-in-elixir-part-1/new_todo_list.png"  alt="New Todo List"  width="826" height="686" />
  
  
    <figcaption 
      class=''
    >
      A new todo list.
    </figcaption>
  
</figure>
<h1 id="about-postgres-policies">About Postgres Policies</h1>
<p>I won&rsquo;t go into detail about Policies because the <a href="https://www.postgresql.org/docs/16/ddl-rowsecurity.html">Postgres docs</a> do a much better job explaining it, but, in short, this is the way you tell Postgres how to filter rows.</p>
<h3 id="a-simple-example-from-the-docs">A simple example from the docs</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-5-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-5-1">1</a></span><span><span style="color:#60a0b0;font-style:italic">-- first enable the RLS for that table
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-5-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-5-2">2</a></span><span><span style="color:#60a0b0;font-style:italic"></span><span style="color:#007020;font-weight:bold">ALTER</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">TABLE</span><span style="color:#bbb"> </span>users<span style="color:#bbb"> </span>ENABLE<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">ROW</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">LEVEL</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">SECURITY</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-5-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-5-3">3</a></span><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-5-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-5-4">4</a></span><span><span style="color:#bbb"></span><span style="color:#60a0b0;font-style:italic">-- create the policy
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-5-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-5-5">5</a></span><span><span style="color:#60a0b0;font-style:italic"></span><span style="color:#007020;font-weight:bold">CREATE</span><span style="color:#bbb"> </span>POLICY<span style="color:#bbb"> </span>user_policy<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">ON</span><span style="color:#bbb"> </span>users<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-5-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-5-6">6</a></span><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">USING</span><span style="color:#bbb"> </span>(user_name<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">current_user</span>);<span style="color:#bbb">
</span></span></span></code></pre></div><p>After running this, from now on, any queries to the <code>users</code> table should add the user_name filter, and this filter can be any SQL query that returns a boolean. Looks pretty simple! But there a few catches I couldn’t figure out yet. Maybe there is a really obvious way to solve these, but here are a few things that got me:</p>
<h3 id="catch-1-dynamic-tenant-id">Catch 1: Dynamic Tenant ID</h3>
<p>I have no idea how to switch the <code>current_user</code> above dynamically. From <a href="https://blog.devgenius.io/postgresql-row-level-security-and-more-2c8c108f9856">the examples</a> I found, they usually run <code>CREATE USER #{tenant}</code> for each tenant on sign up, but I couldn&rsquo;t find a simple way to switch the current_user in Ecto. So, instead I had to rely on <a href="https://www.postgresql.org/docs/current/sql-set.html">setting local configuration parameters</a> and fetching it in the policies with the <a href="https://www.postgresql.org/docs/current/functions-admin.html#FUNCTIONS-ADMIN-SET">current_setting</a> function and it worked good enough.</p>
<p>The example above would be translated to look like this:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-6-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-6-1">1</a></span><span><span style="color:#007020;font-weight:bold">CREATE</span><span style="color:#bbb"> </span>POLICY<span style="color:#bbb"> </span>user_policy<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">ON</span><span style="color:#bbb"> </span>users<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-6-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-6-2">2</a></span><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">USING</span><span style="color:#bbb"> </span>(user_name<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>current_setting(<span style="color:#4070a0">&#39;app.current_user_id&#39;</span>));<span style="color:#bbb">
</span></span></span></code></pre></div><h3 id="catch-2-session-and-local">Catch 2: SESSION and LOCAL</h3>
<p>Configurations and roles can be set at session and local level. We need to set this every time the code accesses the database, and we cannot set it at the session level or database level because otherwise we would have concurrency problems, resulting in users seeing data from other users. So this setting needs to be set within a Postgres transaction:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-7-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-7-1">1</a></span><span><span style="color:#007020;font-weight:bold">BEGIN</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-7-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-7-2">2</a></span><span><span style="color:#bbb">  </span><span style="color:#007020;font-weight:bold">SET</span><span style="color:#bbb"> </span>app.current_user_id<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span><span style="color:#40a070">123</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-7-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-7-3">3</a></span><span><span style="color:#bbb">  </span><span style="color:#007020;font-weight:bold">SELECT</span><span style="color:#bbb"> </span><span style="color:#666">*</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">FROM</span><span style="color:#bbb"> </span>users;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-7-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-7-4">4</a></span><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">END</span>;<span style="color:#bbb">
</span></span></span></code></pre></div><h3 id="catch-3-bypassing-rls">Catch 3: Bypassing RLS</h3>
<p>While learning about all this, I couldn&rsquo;t make this work! I created the policies, I set the local parameter, but it wouldn&rsquo;t filter the query results. I lost so many hours because I didn&rsquo;t know that <a href="https://www.postgresql.org/docs/16/ddl-rowsecurity.html">superusers and table owners completely bypass RLS</a>:</p>
<blockquote>
<p>Superusers and roles with the <code>BYPASSRLS</code> attribute always bypass the row security system when accessing a table. Table owners normally bypass row security as well, though a table owner can choose to be subject to row security with <a href="https://www.postgresql.org/docs/current/sql-altertable.html" title="ALTER TABLE">ALTER TABLE &hellip; FORCE ROW LEVEL SECURITY</a>.</p>
</blockquote>
<p>To fix this, there are some options, but in my case (and for the example of this blog), I decided to keep the <code>postgres</code> Superuser and create a new <a href="https://www.postgresql.org/docs/current/sql-createrole.html">DB user</a> which I could switch to in runtime before running the DB operation:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-8-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-8-1">1</a></span><span><span style="color:#60a0b0;font-style:italic">-- first create a new user/role that does not bypassrls:
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-8-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-8-2">2</a></span><span><span style="color:#60a0b0;font-style:italic"></span><span style="color:#007020;font-weight:bold">CREATE</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">USER</span><span style="color:#bbb"> </span>restricted_user<span style="color:#bbb"> </span>NOBYPASSRLS;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-8-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-8-3">3</a></span><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-8-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-8-4">4</a></span><span><span style="color:#bbb"></span><span style="color:#60a0b0;font-style:italic">-- then before queries use it:
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-8-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-8-5">5</a></span><span><span style="color:#60a0b0;font-style:italic"></span><span style="color:#007020;font-weight:bold">SET</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">LOCAL</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">ROLE</span><span style="color:#bbb"> </span>restricted_user;<span style="color:#bbb">
</span></span></span></code></pre></div><p>With this I was able to keep connecting with superuser, and then the query filtered correctly!</p>
<h1 id="the-migration-plan">The Migration plan</h1>
<p>Given the above, we&rsquo;ll need some DB migrations like this:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-9-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-9-1">1</a></span><span><span style="color:#007020;font-weight:bold">CREATE</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">USER</span><span style="color:#bbb"> </span>restricted_user<span style="color:#bbb"> </span>NOBYPASSRLS;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-9-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-9-2">2</a></span><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">ALTER</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">TABLE</span><span style="color:#bbb"> </span>users<span style="color:#bbb"> </span>ENABLE<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">ROW</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">LEVEL</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">SECURITY</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-9-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-9-3">3</a></span><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-9-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-9-4">4</a></span><span><span style="color:#bbb"></span><span style="color:#60a0b0;font-style:italic">-- I didn&#39;t mention, but the new user needs access to the table:
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-9-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-9-5">5</a></span><span><span style="color:#60a0b0;font-style:italic"></span><span style="color:#007020;font-weight:bold">GRANT</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">ALL</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">ON</span><span style="color:#bbb"> </span>users<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">TO</span><span style="color:#bbb"> </span>restricted_user;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-9-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-9-6">6</a></span><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-9-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-9-7">7</a></span><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">CREATE</span><span style="color:#bbb"> </span>POLICY<span style="color:#bbb"> </span>user_policy<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">ON</span><span style="color:#bbb"> </span>users<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-9-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-9-8">8</a></span><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">TO</span><span style="color:#bbb"> </span>restricted_user<span style="color:#bbb"> </span><span style="color:#60a0b0;font-style:italic">-- I only set it for this user
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-9-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-9-9">9</a></span><span><span style="color:#60a0b0;font-style:italic"></span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">USING</span><span style="color:#bbb"> </span>(user_name<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>current_setting(<span style="color:#4070a0">&#39;app.current_user_id&#39;</span>));<span style="color:#bbb">
</span></span></span></code></pre></div><p>Then our code will run all queries like this:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-10-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-1">1</a></span><span><span style="color:#007020;font-weight:bold">BEGIN</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-10-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-2">2</a></span><span><span style="color:#bbb">  </span><span style="color:#007020;font-weight:bold">SET</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">LOCAL</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">ROLE</span><span style="color:#bbb"> </span>restricted_user;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-10-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-3">3</a></span><span><span style="color:#bbb">  </span><span style="color:#007020;font-weight:bold">SET</span><span style="color:#bbb"> </span>app.current_user_id<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span><span style="color:#40a070">123</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-10-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-4">4</a></span><span><span style="color:#bbb">  </span><span style="color:#007020;font-weight:bold">SELECT</span><span style="color:#bbb"> </span><span style="color:#666">*</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">FROM</span><span style="color:#bbb"> </span>users;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-10-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-5">5</a></span><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">END</span>;<span style="color:#bbb">
</span></span></span></code></pre></div><h1 id="breaking-the-app">Breaking the app</h1>
<p>Let&rsquo;s break the app. Go to <code>lib/todo_trek/todos.ex</code>, find the <code>active_lists/2</code> function and delete all filters using the <code>scope</code> variable. We don&rsquo;t want to bother about this filter at all! Like this:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-elixir" data-lang="elixir"><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-11-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-11-1"> 1</a></span><span>  <span style="color:#007020;font-weight:bold">def</span> active_lists(%<span style="color:#0e84b5;font-weight:bold">Scope</span>{} <span style="color:#666">=</span> scope, limit) <span style="color:#007020;font-weight:bold">do</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-11-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-11-2"> 2</a></span><span>    from(l <span style="color:#007020;font-weight:bold">in</span> <span style="color:#0e84b5;font-weight:bold">List</span>,
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-11-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-11-3"> 3</a></span><span><span style="color:#60a0b0;font-style:italic">#     where: l.user_id == ^scope.current_user.id,</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-11-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-11-4"> 4</a></span><span>      <span style="color:#517918">limit</span>: <span style="color:#666">^</span>limit,
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-11-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-11-5"> 5</a></span><span>      <span style="color:#517918">order_by</span>: [<span style="color:#517918">asc</span>: <span style="color:#517918">:position</span>]
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-11-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-11-6"> 6</a></span><span>    )
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-11-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-11-7"> 7</a></span><span>    <span style="color:#666">|&gt;</span> <span style="color:#0e84b5;font-weight:bold">Repo</span><span style="color:#666">.</span>all()
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-11-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-11-8"> 8</a></span><span>    <span style="color:#666">|&gt;</span> <span style="color:#0e84b5;font-weight:bold">Repo</span><span style="color:#666">.</span>preload(
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-11-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-11-9"> 9</a></span><span>      <span style="color:#517918">todos</span>:
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-11-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-11-10">10</a></span><span>        from(t <span style="color:#007020;font-weight:bold">in</span> <span style="color:#0e84b5;font-weight:bold">Todo</span>,
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-11-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-11-11">11</a></span><span><span style="color:#60a0b0;font-style:italic">#         where: t.user_id == ^scope.current_user.id,</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-11-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-11-12">12</a></span><span>          <span style="color:#517918">limit</span>: <span style="color:#4070a0">@max_todos</span>,
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-11-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-11-13">13</a></span><span>          <span style="color:#517918">order_by</span>: [<span style="color:#517918">asc</span>: t<span style="color:#666">.</span>position]
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-11-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-11-14">14</a></span><span>        )
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-11-15"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-11-15">15</a></span><span>    )
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-11-16"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-11-16">16</a></span><span>  <span style="color:#007020;font-weight:bold">end</span>
</span></span></code></pre></div><p>If you refresh the browser, you should be able to see the lists from all users. Kaboom!</p>





<figure class='mb-5'>
  <img src="/posts/row-level-security-with-postgres-in-elixir-part-1/app_with_broken_rls.png"  alt="App with broken RLS"  width="1912" height="782" />
  
  
    <figcaption 
      class=''
    >
      Lists from other users appearing in the app.
    </figcaption>
  
</figure>
<p>Not <em>my</em> list.</p>
<h1 id="fixing-the-app-with-postgres-rls">Fixing the app with Postgres RLS</h1>
<p>Alright! Let&rsquo;s create the migrations I mentioned, then fix this with RLS!</p>
<h3 id="create-the-rls-user">Create the RLS user</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-12-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-1">1</a></span><span>mix ecto.gen.migration create_restricted_user
</span></span></code></pre></div><p>Open the generated file, and let&rsquo;s just follow the example from the Migration plan:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-elixir" data-lang="elixir"><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-13-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-1"> 1</a></span><span><span style="color:#60a0b0;font-style:italic"># priv/repo/migrations/20240120163737_create_restricted_user.exs</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-13-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-2"> 2</a></span><span><span style="color:#007020;font-weight:bold">defmodule</span> <span style="color:#0e84b5;font-weight:bold">TodoTrek.Repo.Migrations.CreateRestrictedUser</span> <span style="color:#007020;font-weight:bold">do</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-13-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-3"> 3</a></span><span>  <span style="color:#007020;font-weight:bold">use</span> <span style="color:#0e84b5;font-weight:bold">Ecto.Migration</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-13-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-4"> 4</a></span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-13-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-5"> 5</a></span><span>  <span style="color:#007020;font-weight:bold">def</span> up <span style="color:#007020;font-weight:bold">do</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-13-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-6"> 6</a></span><span>    execute(<span style="color:#4070a0">&#34;CREATE USER restricted_user NOBYPASSRLS&#34;</span>)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-13-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-7"> 7</a></span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-13-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-8"> 8</a></span><span>	<span style="color:#60a0b0;font-style:italic"># DO NOT RUN THIS IN PRODUCTION! GRANT ONLY WHAT IS NEEDED!</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-13-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-9"> 9</a></span><span>    <span style="color:#60a0b0;font-style:italic"># grants all powers on all tables</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-13-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-10">10</a></span><span>    execute(<span style="color:#4070a0">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-13-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-11">11</a></span><span><span style="color:#4070a0">    GRANT ALL
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-13-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-12">12</a></span><span><span style="color:#4070a0">    ON ALL TABLES
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-13-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-13">13</a></span><span><span style="color:#4070a0">    IN SCHEMA public
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-13-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-14">14</a></span><span><span style="color:#4070a0">    TO restricted_user;
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-13-15"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-15">15</a></span><span><span style="color:#4070a0">    &#34;&#34;&#34;</span>)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-13-16"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-16">16</a></span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-13-17"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-17">17</a></span><span>	<span style="color:#60a0b0;font-style:italic"># DO NOT RUN THIS IN PRODUCTION!</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-13-18"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-18">18</a></span><span>    <span style="color:#60a0b0;font-style:italic"># This grants all on future tables</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-13-19"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-19">19</a></span><span>    execute(<span style="color:#4070a0">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-13-20"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-20">20</a></span><span><span style="color:#4070a0">    ALTER DEFAULT PRIVILEGES IN SCHEMA public
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-13-21"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-21">21</a></span><span><span style="color:#4070a0">    GRANT ALL
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-13-22"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-22">22</a></span><span><span style="color:#4070a0">    ON TABLES
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-13-23"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-23">23</a></span><span><span style="color:#4070a0">    TO restricted_user;
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-13-24"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-24">24</a></span><span><span style="color:#4070a0">    &#34;&#34;&#34;</span>)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-13-25"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-25">25</a></span><span>  <span style="color:#007020;font-weight:bold">end</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-13-26"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-26">26</a></span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-13-27"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-27">27</a></span><span>  <span style="color:#60a0b0;font-style:italic"># As an exercise, implement the `down` function</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-13-28"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-28">28</a></span><span>  <span style="color:#007020;font-weight:bold">def</span> down <span style="color:#007020;font-weight:bold">do</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-13-29"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-29">29</a></span><span>  <span style="color:#007020;font-weight:bold">end</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-13-30"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-30">30</a></span><span><span style="color:#007020;font-weight:bold">end</span>
</span></span></code></pre></div>


<div class="alert-box error">
  
    <h3 class="alert-title">DO NOT USE THIS IN PRODUCTION!</h3>
  
  <p class="flex flex-row items-center gap-2">
    
    <svg
      xmlns="http://www.w3.org/2000/svg"
      fill="none"
      viewBox="0 0 24 24"
      stroke-width="1.5"
      stroke="currentColor"
      class="alert-icon"
    >
      <path
        stroke-linecap="round"
        stroke-linejoin="round"
        d="M12 9v3.75m9-.75a9 9 0 11-18 0 9 9 0 0118 0zm-9 3.75h.008v.008H12v-.008z"
      />
    </svg>
    
    
Reach out to your DB expert about the grants and default privileges! Do not use this blindly in production! Privilege levels is out of scope of this post, but for simplicity I am granting all on everything.

  </p>
</div>

<h3 id="create-the-policy">Create the Policy</h3>
<p>I&rsquo;ll do it only for the lists table and won&rsquo;t bother about the todos table, but <strong>we should</strong>! Feel free to do it as an exercise.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-14-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-14-1">1</a></span><span>mix ecto.gen.migration create_rls_policy_for_lists
</span></span></code></pre></div><p>Open the generated file, and let&rsquo;s just follow the example from the Migration plan again:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-elixir" data-lang="elixir"><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-15-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-15-1"> 1</a></span><span><span style="color:#60a0b0;font-style:italic"># priv/repo/migrations/20240120164315_create_rls_policy_for_lists.exs</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-15-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-15-2"> 2</a></span><span><span style="color:#007020;font-weight:bold">defmodule</span> <span style="color:#0e84b5;font-weight:bold">TodoTrek.Repo.Migrations.CreateRlsPolicyForLists</span> <span style="color:#007020;font-weight:bold">do</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-15-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-15-3"> 3</a></span><span>  <span style="color:#007020;font-weight:bold">use</span> <span style="color:#0e84b5;font-weight:bold">Ecto.Migration</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-15-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-15-4"> 4</a></span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-15-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-15-5"> 5</a></span><span>  <span style="color:#007020;font-weight:bold">def</span> up <span style="color:#007020;font-weight:bold">do</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-15-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-15-6"> 6</a></span><span>    execute(<span style="color:#4070a0">&#34;ALTER TABLE lists ENABLE ROW LEVEL SECURITY;&#34;</span>)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-15-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-15-7"> 7</a></span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-15-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-15-8"> 8</a></span><span>    execute(<span style="color:#4070a0">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-15-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-15-9"> 9</a></span><span><span style="color:#4070a0">    CREATE POLICY list_policy ON lists
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-15-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-15-10">10</a></span><span><span style="color:#4070a0">    TO restricted_user
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-15-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-15-11">11</a></span><span><span style="color:#4070a0">    USING (user_id = current_setting(&#39;app.current_user_id&#39;)::bigint);
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-15-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-15-12">12</a></span><span><span style="color:#4070a0">    &#34;&#34;&#34;</span>)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-15-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-15-13">13</a></span><span>  <span style="color:#007020;font-weight:bold">end</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-15-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-15-14">14</a></span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-15-15"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-15-15">15</a></span><span>  <span style="color:#007020;font-weight:bold">def</span> down <span style="color:#007020;font-weight:bold">do</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-15-16"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-15-16">16</a></span><span>    <span style="color:#60a0b0;font-style:italic"># exercise</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-15-17"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-15-17">17</a></span><span>  <span style="color:#007020;font-weight:bold">end</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-15-18"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-15-18">18</a></span><span><span style="color:#007020;font-weight:bold">end</span>
</span></span></code></pre></div><p>See that <code>::bigint</code> in there? That&rsquo;s necessary because the <code>user_id</code> is an integer, but the <code>current_setting</code> returns <code>text</code>. It needs conversion!</p>
<h3 id="rls-in-action">RLS in action!</h3>
<p>Run <code>mix ecto.migrate</code>, and let&rsquo;s see it in action in IEX!</p>
<pre tabindex="0"><code>iex -S mix phx.server
</code></pre><p><strong>Without RLS</strong>
Assuming that you created more account with Todos, running this should return all lists from all users:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-elixir" data-lang="elixir"><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-17-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-17-1">1</a></span><span>iex<span style="color:#666">&gt;</span> lists <span style="color:#666">=</span> <span style="color:#0e84b5;font-weight:bold">TodoTrek.Todos</span><span style="color:#666">.</span>active_lists(%<span style="color:#0e84b5;font-weight:bold">TodoTrek.Scope</span>{}, <span style="color:#40a070">10</span>)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-17-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-17-2">2</a></span><span>iex<span style="color:#666">&gt;</span> <span style="color:#0e84b5;font-weight:bold">Enum</span><span style="color:#666">.</span>map(lists, <span style="color:#666">&amp;</span> <span style="color:#d55537;font-weight:bold">&amp;1</span><span style="color:#666">.</span>user_id) <span style="color:#666">|&gt;</span> <span style="color:#0e84b5;font-weight:bold">Enum</span><span style="color:#666">.</span>uniq()
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-17-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-17-3">3</a></span><span>[<span style="color:#40a070">1</span>, <span style="color:#40a070">2</span>]
</span></span></code></pre></div><p>Oops! We need to set the <code>app.current_user_id</code> and <code>restricted_user</code>!</p>
<p><strong>With RLS</strong></p>
<p>It doesn&rsquo;t look nice, but stay with me:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-elixir" data-lang="elixir"><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-18-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-18-1"> 1</a></span><span>iex<span style="color:#666">&gt;</span> <span style="color:#007020;font-weight:bold">alias</span> <span style="color:#0e84b5;font-weight:bold">TodoTrek.Repo</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-18-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-18-2"> 2</a></span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-18-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-18-3"> 3</a></span><span>iex<span style="color:#666">&gt;</span> {<span style="color:#517918">:ok</span>, lists} <span style="color:#666">=</span> <span style="color:#0e84b5;font-weight:bold">Repo</span><span style="color:#666">.</span>transaction(<span style="color:#007020;font-weight:bold">fn</span> <span style="color:#666">-&gt;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-18-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-18-4"> 4</a></span><span>iex<span style="color:#666">&gt;</span>   <span style="color:#0e84b5;font-weight:bold">Repo</span><span style="color:#666">.</span>query!(<span style="color:#4070a0">&#34;SET LOCAL ROLE restricted_user;&#34;</span>)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-18-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-18-5"> 5</a></span><span>iex<span style="color:#666">&gt;</span>   <span style="color:#0e84b5;font-weight:bold">Repo</span><span style="color:#666">.</span>query!(<span style="color:#4070a0">&#34;SET app.current_user_id = &#39;1&#39;;&#34;</span>)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-18-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-18-6"> 6</a></span><span>iex<span style="color:#666">&gt;</span>   <span style="color:#0e84b5;font-weight:bold">TodoTrek.Todos</span><span style="color:#666">.</span>active_lists(%<span style="color:#0e84b5;font-weight:bold">TodoTrek.Scope</span>{}, <span style="color:#40a070">20</span>)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-18-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-18-7"> 7</a></span><span>iex<span style="color:#666">&gt;</span> <span style="color:#007020;font-weight:bold">end</span>)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-18-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-18-8"> 8</a></span><span>...
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-18-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-18-9"> 9</a></span><span>iex<span style="color:#666">&gt;</span> <span style="color:#0e84b5;font-weight:bold">Enum</span><span style="color:#666">.</span>map(lists, <span style="color:#666">&amp;</span> <span style="color:#d55537;font-weight:bold">&amp;1</span><span style="color:#666">.</span>user_id) <span style="color:#666">|&gt;</span> <span style="color:#0e84b5;font-weight:bold">Enum</span><span style="color:#666">.</span>uniq()
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-18-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-18-10">10</a></span><span>[<span style="color:#40a070">1</span>]
</span></span></code></pre></div><p>It works!</p>
<p>Try again without the <code>SET LOCAL ROLE restricted_user</code> and see what happens. It should return all anyway because it runs the query with the superuser which bypasses RLS.</p>
<h2 id="replace-the-function">Replace the function</h2>
<p>Let&rsquo;s move all this to <code>active_lists/2</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-elixir" data-lang="elixir"><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-19-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-19-1"> 1</a></span><span>  <span style="color:#007020;font-weight:bold">def</span> active_lists(%<span style="color:#0e84b5;font-weight:bold">Scope</span>{} <span style="color:#666">=</span> scope, limit) <span style="color:#007020;font-weight:bold">do</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-19-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-19-2"> 2</a></span><span>    {<span style="color:#517918">:ok</span>, lists} <span style="color:#666">=</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-19-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-19-3"> 3</a></span><span>      <span style="color:#0e84b5;font-weight:bold">Repo</span><span style="color:#666">.</span>transaction(<span style="color:#007020;font-weight:bold">fn</span> <span style="color:#666">-&gt;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-19-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-19-4"> 4</a></span><span>        <span style="color:#0e84b5;font-weight:bold">Repo</span><span style="color:#666">.</span>query!(<span style="color:#4070a0">&#34;SET LOCAL ROLE restricted_user;&#34;</span>)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-19-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-19-5"> 5</a></span><span>        <span style="color:#0e84b5;font-weight:bold">Repo</span><span style="color:#666">.</span>query!(<span style="color:#4070a0">&#34;SET app.current_user_id = &#39;</span><span style="color:#70a0d0">#{</span>scope<span style="color:#666">.</span>current_user<span style="color:#666">.</span>id<span style="color:#70a0d0">}</span><span style="color:#4070a0">&#39;;&#34;</span>)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-19-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-19-6"> 6</a></span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-19-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-19-7"> 7</a></span><span>        from(l <span style="color:#007020;font-weight:bold">in</span> <span style="color:#0e84b5;font-weight:bold">List</span>,
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-19-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-19-8"> 8</a></span><span>          <span style="color:#517918">limit</span>: <span style="color:#666">^</span>limit,
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-19-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-19-9"> 9</a></span><span>          <span style="color:#517918">order_by</span>: [<span style="color:#517918">asc</span>: <span style="color:#517918">:position</span>]
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-19-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-19-10">10</a></span><span>        )
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-19-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-19-11">11</a></span><span>        <span style="color:#666">|&gt;</span> <span style="color:#0e84b5;font-weight:bold">Repo</span><span style="color:#666">.</span>all()
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-19-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-19-12">12</a></span><span>        <span style="color:#666">|&gt;</span> <span style="color:#0e84b5;font-weight:bold">Repo</span><span style="color:#666">.</span>preload(
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-19-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-19-13">13</a></span><span>          <span style="color:#517918">todos</span>:
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-19-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-19-14">14</a></span><span>            from(t <span style="color:#007020;font-weight:bold">in</span> <span style="color:#0e84b5;font-weight:bold">Todo</span>,
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-19-15"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-19-15">15</a></span><span>              <span style="color:#517918">limit</span>: <span style="color:#4070a0">@max_todos</span>,
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-19-16"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-19-16">16</a></span><span>              <span style="color:#517918">order_by</span>: [<span style="color:#517918">asc</span>: t<span style="color:#666">.</span>position]
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-19-17"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-19-17">17</a></span><span>            )
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-19-18"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-19-18">18</a></span><span>        )
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-19-19"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-19-19">19</a></span><span>      <span style="color:#007020;font-weight:bold">end</span>)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-19-20"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-19-20">20</a></span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-19-21"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-19-21">21</a></span><span>    lists
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-19-22"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-19-22">22</a></span><span>  <span style="color:#007020;font-weight:bold">end</span>
</span></span></code></pre></div><p>Refreshing the page should get you back to the initial and correct state. But this code looks so ugly, and repeating this everywhere wouldn&rsquo;t be fun. I honestly wouldn&rsquo;t want to imagine the reviews on this code!</p>
<p>We need to find a way to wrap all DB calls with the transaction above, then everything will be automatically filtered by Postgres. I want the function to look like this and get rid of the <code>scope</code> argument:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-elixir" data-lang="elixir"><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-20-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-20-1"> 1</a></span><span>  <span style="color:#007020;font-weight:bold">def</span> active_lists(limit) <span style="color:#007020;font-weight:bold">do</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-20-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-20-2"> 2</a></span><span>    from(l <span style="color:#007020;font-weight:bold">in</span> <span style="color:#0e84b5;font-weight:bold">List</span>,
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-20-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-20-3"> 3</a></span><span>      <span style="color:#517918">limit</span>: <span style="color:#666">^</span>limit,
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-20-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-20-4"> 4</a></span><span>      <span style="color:#517918">order_by</span>: [<span style="color:#517918">asc</span>: <span style="color:#517918">:position</span>]
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-20-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-20-5"> 5</a></span><span>    )
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-20-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-20-6"> 6</a></span><span>    <span style="color:#666">|&gt;</span> <span style="color:#0e84b5;font-weight:bold">Repo</span><span style="color:#666">.</span>all()
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-20-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-20-7"> 7</a></span><span>    <span style="color:#666">|&gt;</span> <span style="color:#0e84b5;font-weight:bold">Repo</span><span style="color:#666">.</span>preload(
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-20-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-20-8"> 8</a></span><span>      <span style="color:#517918">todos</span>:
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-20-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-20-9"> 9</a></span><span>        from(t <span style="color:#007020;font-weight:bold">in</span> <span style="color:#0e84b5;font-weight:bold">Todo</span>,
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-20-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-20-10">10</a></span><span>          <span style="color:#517918">limit</span>: <span style="color:#4070a0">@max_todos</span>,
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-20-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-20-11">11</a></span><span>          <span style="color:#517918">order_by</span>: [<span style="color:#517918">asc</span>: t<span style="color:#666">.</span>position]
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-20-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-20-12">12</a></span><span>        )
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-20-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-20-13">13</a></span><span>    )
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-20-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-20-14">14</a></span><span>  <span style="color:#007020;font-weight:bold">end</span>
</span></span></code></pre></div><h1 id="next-steps">Next steps</h1>
<p>On the next post I will continue working on the example above. I should a few ways I learned to wrap all DB calls in a transaction that sets the local role and current_user_id parameter. We&rsquo;ll learn about Process dictionary and wrapping the TodoTrek.Repo functions!</p>
</section>

  
    
  
    <div class="giscus-comment">
    <script
      src="https://giscus.app/client.js"
      data-repo="vrcca/vrcca.github.io"
      data-repo-id="MDEwOlJlcG9zaXRvcnkyNTQzODE2Ng=="
      data-category="Announcements"
      data-category-id="DIC_kwDOAYQn1s4CdHIg"
      data-mapping="pathname"
      data-strict="0"
      data-reactions-enabled="1"
      data-emit-metadata="0"
      data-input-position="top"
      data-theme="light"
      data-lang="en"
      
        data-loading="lazy"
      
      crossorigin="anonymous"
      async
    >
    </script>
</div>
  

    
  


  <footer>
    
      <div class="pb-14 taxonomy-list tags-list">
      
        <a href="/tags/elixir/" alt="elixir">
          elixir
        </a>
      
        <a href="/tags/postgres/" alt="postgres">
          postgres
        </a>
      
        <a href="/tags/blog/" alt="blog">
          blog
        </a>
      
      </div>
    
  </footer>
</article>


    </main><footer class="pt-5 pb-10 grid gap-3 sm:grid-cols-2">
    <div class="text-xs font-semibold text-gray-500 order-2 sm:order-1">
  © 2024 —
  <a href="https://blog.vitor.info/">Vitor Cavalcanti</a> 
  <span class="font-normal">with</span>
  <a
    href="https://github.com/nixentric/Lowkey-Hugo-Theme"
    target="_blank"
    rel="noopener noreferrer"
  >
    Lowkey
  </a>
</div>

    <div class="order-1 sm:order-2">
  <ul class="flex sm:justify-end gap-5">
    
    
    <li>    
      <a href="https://genserver.social/vitor" target="_blank" rel="noopener noreferrer">Fediverse</a>
    </li>
    
    <li>    
      <a href="https://linkedin.com/in/vrcca" target="_blank" rel="noopener noreferrer">LinkedIn</a>
    </li>
    
    <li>    
      <a href="https://github.com/vrcca" target="_blank" rel="noopener noreferrer">GitHub</a>
    </li>
    
    
  </ul>
</div>

</footer></body>
</html>
